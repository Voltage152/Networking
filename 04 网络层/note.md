#### 网络层

* 本章有 3 个主要部分:
	* 涉及网络层功能和服务 (4.1 ~ 4.2)
	* 转发 (4.3 ~ 4.4)
	* 路由选择 (4.5 ~ 4.7)
	
* 4.1 **概述**
	* 路由器的主要作用是将数据包从入链路转发到出链路，除了控制目的外的路由器不运行应用层和运输层协议。
	* ⚠️**不能理解为路由器没有实现运输层或应用层协议**

	
	* 4.1.1 **转发和路由选择**
		* 网络层为了实现将分组从一台发送主机移动到一台接受主机，需要两种功能。
			* **转发**: 路由器将到达它某条输入链路的分组移动到适当的输出链路。
			* **路由选择**: 在路由器图结构中决定分组从源端到目的端的路径的算法。
			* **连接建立**: ⚠️待补充
			
		* **分组交换机**
			* **链路层交换机**：基于链路层字段作转发决定
			* **路由器**：基于网络层字段作转发决定
	
	* 4.1.2 **网络层服务模型**
		* 网络层服务模型决定了分组的端到端运输特性，下列是网络层可能提供的服务：
			* **确保交付**：该服务确保分组最终到达目的地。
			* **具有时延上界的确保交付**
			* **有序分组交付**
			* **确保最小带宽**：模拟在发送方和接收方之间一条特定比特率的传输链路行为。只要发送主机以低于特定比特率的速率传输比特，则分组不会丢失，且每个分组会在预定的端到端时延内到达。
			* **确保最大时延抖动**：确保目的方接收两个相继分组的时间间隔等于发送方发送这两个相继分组的时间间隔，或者该间隔不超过某个特定值。
			* **安全性服务**：使用仅由源和目的主机知晓会话秘钥，加密从源主机到目的主机的所有数据包负载。
		
		* 因特网、`ATM CBR` 和 `ATM ABR` 服务模型
		
	 	| 网络体系结构|服务模型|带宽保证|无丢包保证|有序|定时|拥塞指示|
    	| :--------:|:-----:|:----:|:----:|:----:|:----:|:----:|
    	| 因特网	| 尽力而为	|  无    | 无 |  任何可能顺序 | 不维护| 无 |
    	| ATM		| 恒定比特率| 保证恒定速率 | 是 | 有序 | 维护 | 不出现拥塞 |
    	| ATM 	| 可用比特率| 保证最小速率 | 无 | 有序 | 不维护 | 提供拥塞指示 |
   
   
  * 4.2 **虚电路和数据报网络**
 
  	 * ⚠️ **运输层的连接服务仅在端系统中实现，而网络层的连接服务即在端系统中实现，也在路由器中实现。**
  		
  	 * 4.2.1 **虚电路网络**: 网络层提供连接服务的计算机网络
  	 	 * 虚电路组成如下：
  	 	  	 * 1、源和目的主机之间的路径 (一系列路由器和链路)
  	 	  	 * 2、VC 号，沿着该路径的每段链路的一个号码
  	 	  	 * 3、沿着该路径的每台路由器中的转发表表项
  	 	 * 属于一条虚电路的分组会在首部携带一个 VC 号。一条虚电路在每条链路上可能具有不同的 VC 号，每台中间路由器必须用一个新的 VC 号替代每个传输分组的 VC 号。该新的 VC 号从转发表获得，下面的表格是路由器中包含 VC 号的转发表。
  	 	 
	  	 * | 入接口号 |入 VC 号|出接口号|出 VC 号|
	  	 	|:---:|:---:|:---:|:---:|
	  	 	| 1 | 12 |2 |22 |
	  	 	|2|63|1|18|
	  	 	|3|7|2|17|
	  	 	|4|97|3|87|
	  	 	|...|...|...|...|
  	 	 
  	 	 * ![](https://github.com/YangXiaoHei/Networking/blob/master/04%20网络层/images/VC_number.png)

  	 	 * **虚电路建立**: 网络层决定发送方与接收方之间的路径，并为该路径的每条链路决定一个 VC 号，最后在沿着该路径的每台路由器转发表中增加一个表项，并预留该虚电路路径上的资源比如带宽。
  	 	 
  	 	 * **数据传送**: 分组沿着该虚电路流动

  	 	 * **虚电路拆除**: 发送方或接收方通知网络层终止该虚电路时，网络层将通知网络另一侧的端系统结束呼叫，然后删除该路径上每台路由器中的转发表的相应表项，以此表明该虚电路已经不存在。
  	 	 
  	 * 4.2.2 **数据报网络**: 网络层不提供连接服务的计算机网络
		 * 路由器使用分组的目的地址的 **前缀** 进行 **最长前缀匹配** 来决定将该分组导向哪条输出链路。

		 * 数据报网络中的转发表是通过路由选择算法修改的
		 
		 * 因为数据报网络中的转发表能够在任何时刻修改，从一个端系统到另一个端系统发送的分组可能在通过网络时走不通的路径，并可能无序到达。

  * 4.3 **路由器工作原理**
  	
  	* ![](https://github.com/YangXiaoHei/Networking/blob/master/04%20网络层/images/Router_structure.png)
  	
  	* 4.3.1 **输入端口**
  		* **物理层和链路层处理**
  		* **检查分组版本号，检查并重写校验和以及寿命字段**
  		* **更新用于网络管理的计数器**
  		* **搜索转发表查找最长前缀匹配，决定分组的输出链路**
  	
  	* 4.3.2 **交换结构**
  		* ![](https://github.com/YangXiaoHei/Networking/blob/master/04%20网络层/images/Switching_3_structure.png)
  		* **经内存交换**
  			* **输入端口与输出端口之间的交换是在 CPU (路由选择处理器) 的直接控制下完成的，如果内存带宽为每秒可写进内存或从内存读出 B 个分组，则总的转发吞吐量 (分组从输入端口被传送到输出端口的总速率) 必然小于 B/2，并且不能同时转发两个分组，即便它们有不同的端口号，因为经过共享系统总线一次仅能执行一个内存读/写**
  			
  			* 1、分组到达输入端口

  			* 2、通过中断方式向路由选择处理器发出信号
  			
  			* 3、分组从输入端口处被复制到处理器内存中
  			
  			* 4、路由选择处理器从首部中提取目的地址，查找转发表并匹配最长前缀，决定适当的输出端口
  			
  			* 5、路由选择处理器将该分组复制到输出端口缓存中。

  		* **经总线交换**
			* **不需要路由选择处理器干预，输入端口经一根共享总线将分组直接传送到输出端口，由于一次只能有一个分组能够跨越总线，因此总的转发吞吐量受总线传播分组速率的限制**
			
			* 1、输入端口为分组预先设置一个交换剂内部标签 (首部), 指示本地输出端口
			
			* 2、分组由总线传送到输出端口

			* 3、所有端口都能收到该分组，但只有内部标签匹配的端口才能保存该分组。
			* 4、输出端口处去掉该分组的内部标签
			
  		* **经互联网络交换**
  			* **能够并行转发多个分组，但如果来自两个不同输入端口的分组其目的地为相同的输出端口，则其中一个分组必须在输入端等待，因为在每个时刻经给定总线仅有一个分组能够发送**
  			
  	* 4.3.4 何处出现排队
  		* 输入端口
  			* 若 `Rswitch` 比 `Rline` 快 N 倍，那么即便分组是突然性到达，每个分组也仅会经受微不足道的时延，并且每批分组能在下一批到达前被交换结构处理完毕，但是，若交换结构不能快得让所有到达分组都无时延通过它传送，则在输入端口处也会排队
  			
		   * 另一种排队是因为 **线路前部阻塞**，这是因为输入队列中排在后面的分组，必须等待前面的分组被交换结构处理完毕，即使排在后面的分组要去往的输出端口是空闲的，入下图所示。
		   
		   * ![](https://github.com/YangXiaoHei/Networking/blob/master/04%20网络层/images/HOL.png)
  			
  		* 输出端口
  			* 若 `Rswitch` 比 `Rline` 快 N 倍，那么最坏情况下，若所有到达输入端口的分组都要去到同一个输出端口，则在输出端口发送完 1 个分组的时间内，就到达了 N 个分组，再发送完一个分组，又到达 N 个分组，这将导致输出端口可用内存被很快耗尽，最终产生大量丢包。

  			* 输出端口上的 **分组调度程序** 必须在排队的分组中选出一个来发送，策略有 **先到先服务 (FCFS)**，或者 **加权公平排队（WFQ）**
  		
  		* 路由器缓存长度经验公式
  			* `缓存数量 B = 平均往返时延 RTT x 链路容量 C`
  			* `缓存数量 B = RTT * C/sqrt(N)`

  * 4.4 **网际协议：因特网中的转发和编址**
  
  	 * **4.4.1 数据报格式**
  	 
  	 	 * ![](https://github.com/YangXiaoHei/Networking/blob/master/04%20网络层/images/IPv4报文格式.png)
		
		 * IP 数据报分片
		 	* 并不是所有链路层协议都能承载相同长度的网络层分组。有的协议能承载大数据报，有的只能承载小数据报。例如，以太网帧能承载不超过 1500 字节的数据，而某些广域网链路的帧可承载不超过 576 字节的数据。一个链路层帧能承载的最大数据量叫做 **最大传送单元 MTU**，每个 IP 数据报封装在链路层帧中从一台路由器传输到下一台路由器，所以链路层帧的 MTU 严格限制着 IP 数据报的长度。并且发送方到接收方路径上的每段链路可能使用不同的链路层协议，每种协议可能有不同的 MTU。
		 	
		 	* ⚠️ 路由器中可能会执行 IP 数据报的分片操作，当下一段链路的 MTU 小于路由器接收到的 IP 数据报长度时。但是数据报的组装工作只在端系统的网络层进行，而不会在路由器的网络层进行。如果一个或多个片没有到达目的地，则该不完整的数据报会被接收方的网络层丢弃。
		 	
		 	* ![](https://gith ub.com/YangXiaoHei/Networking/blob/master/04%20网络层/images/分片和组装.png)

		 	* 可以通过设置片的偏移量从而使数据报无法恰当的重建来攻击，IPv6 禁止分片，从而简化了 IP 分组的处理，并使得 IP 不太容易收到攻击。
		 	
	* **4.4.2 IPv4 编址**
		*  IP 地址是与每一个接口相关联，而不是与包括该接口的主机或路由器相关联的
		
		*  因特网的地址分配策略是 ：CIDR，对于子网寻址，32 比特的 IP 地址被划分为两部分，并具有 a.b.c.d/x 的点分十进制形式。x 数目的最高比特构成了网络前缀。
		
		*  **主机或子网如何获取 IP 地址** 
		
			* **1、获取一块地址**
				* ICANN 给 ISP 分配可用 IP 地址范围，ISP 给内部子网分配可用 IP 地址范围
			
			* **2、获取主机地址 : DHCP 动态主机配置协议**
			
				* DHCP 允许主机自动获取一个 IP 地址，网络管理员能够配置 DHCP 使得主机每次与网络连接能否获得一个相同 IP 地址，或者某主机将被分配一个临时的 IP 地址，除了获得 IP 地址，DHCP 还允许一台主机得知其他信息，比如：子网掩码、第一跳路由器地址，本地 DNS 服务器地址。
				
				* 通过 DHCP 获取 IP 地址的步骤如下图所示
				
				  ![](https://github.com/YangXiaoHei/Networking/blob/master/04%20网络层/images/DHCP_interaction.png)
		
			* **3、网络地址转换 NAT**
			
				* 具有 NAT 功能的路由器修改分组的 IP/Port 地址，使得子网内部的 IP 地址都可以自由分配，只需要在 NAT 表中完成到因特网 IP/Port 地址的映射关系即可。
				
				* 缺点 : 对 P2P 应用不友好，因为躲在 NAT 路由器背后的主机不能充当接入主动连接的服务器，此时需要 NAT 穿越。
				
			* **4、UPnP**
				
				* UPnP 允许外部主机使用 TCP 或 UDP 向 NAT 化的主机发起通信会话，UPnP 由于提供了有效和健壮的 NAT 穿越解决方案，可能成为 P2P 应用程序的救世主。
		
	* **4.4.3 因特网控制报文协议 ICMP**  
	
	* **4.4.4 IPv6** 
	
		* 1、IPv6 数据报格式
		
		* 2、从 IPv4 到 IPv6 的迁移
		
	* **4.5 路由选择算法**
		
		* **4.5.1 链路状态路由选择算法**
			
			~~~
			对于出发结点 x
			初始化:
				1、对于每个目的结点 y, 计算 x -> y 的距离，若 y 不是 x 的邻居，那么距离为 ∞
				2、w = x
			
			循环直到 N' 队列容纳的元素个数等于 N
				1、找到当前访问结点 w 到所有邻居的最小距离 D(w)，将 w 添加进队列 N'，此时 N` 的元素个数加 1
				2、松弛 w 的所有邻边
			~~~
			
			* 振荡现象
			
			 * ![](https://github.com/YangXiaoHei/Networking/blob/master/04%20网络层/images/Oscillations.png)
			  
			 * 避免路由器自同步的方法 : 让每台路由器发送链路通告的时间随机化
			
		* **4.5.2 距离向量路由选择算法**
		
		~~~
		对于每个结点 x :
		初始化:
			1、对于每一个目的结点 y, 计算 x -> y 的距离，若 y 不是 x 的邻居，那么距离为 ∞
			2、对于 x 的每个邻居 w, 初始化每个 w -> y 的距离为 ∞
			3、对于 x 的每个邻居 w, x 将自己的距离向量 Dx 逐个发送给它们
			
		死循环
			等待下列事件触发，然后执行语句 [-]
					1、到达邻居 w 的链路费用发生改变
					2、收到来自邻居 w 的距离向量
					
			[-] 对于每一个目的结点 y，计算 x -> y 的距离
				 Dx(y) = MINv{ c(x, y) + Dv(y) }
			
			如果某个 Dx(y) 发生更新，那么对于 x 的每个邻居 w, 
			x 将自己的距离向量 Dx 逐个发送给它们
		~~~
			
	 
  		



	 
	 