#### 三、运输层

* 3.1 概述和运输层服务
 	* **网络层** 为不同主机提供逻辑通信，**运输层** 为不同主机上的应用进程提供逻辑通信。

 	
 	* **运输层** 只在端系统中实现，路由器只提取网络数据报报头，而不检查里面封装的运输层报文段。

 	
 	* **UDP** 和 **TCP** 是提供不同服务的运输层协议。
* 3.1.1 运输层和网络层的关系
 	* 两个家庭孩子们收发信件的比喻
 	
 	* 运输层协议受制于网络层协议，如果网络层协议不提供时延和带宽的保证，那么运输层协议同样不能提供带宽和时延的保证。

 	
 	* 运输层协议仍然能够提供网络层协议不支持的服务， 比如可靠性保证（无差错，顺序，无冗余）安全性保证（加密）

 	
* 3.1.2 因特网运输层概述
 	* **UDP** 提供不可靠，无连接的服务，**TCP** 提供可靠的，面向连接的服务。

 	
 	* 术语选择：在本书中运输层无论是 **TCP** 还是 **UDP** 都使用 **报文段** 而不是 **数据包**。

 	
 	* **IP** 是不可靠服务，每台主机至少有一个 **IP** 地址。

 	
 	* 将主机间的交互扩展为进程间的交互被称为运输层的 **多路复用** 和 **多路分解** 操作。

 	
 	* 进程到进程的 **数据交付（复用/分解服务）** 和 **差错检查** 是两种最低限度的运输层服务，也是 **UDP** 所能提供的仅有服务。

 	
 	* **TCP** 拥塞控制防止任何一条 **TCP** 连接用过多流量来淹没通信主机之间的链路和交换设备。**TCP** 力求为每条连接平等地共享网络链路带宽。**UDP** 流量则是不可调节的，使用 **UDP** 的应用程序可以用任何速率来发送数据。

 	
* 3.2 多路复用与多路分解
	* 将运输层报文段中的数据交付到正确的套接字的工作称为 **多路分解**，从不同套接字中收集数据块，为每个数据块封装上首部信息从而生成报文段，然后将这些报文段传递到网络层的工作成为 **多路复用**。
	
	* **无连接的`多路复用`与`多路分解`**
		* **UDP** 套接字使用 `(dst_IP、dst_port)` 来标识，若两个报文段 `src_port` 和 `src_IP` 不一样，但 `dst_IP` 和 `dst_port` 一样，会被定位到相同的套接字。
		* 两个 B 主机上的进程（源端口不同）向 A 发送 **UDP** 报文，会被 A 定位到相同的套接字。
	* **面向连接的 `多路复用` 与 `多路分解`**
		* **TCP** 套接字使用 `(dst_IP、dst_port、src_IP、src_port)` 来标识，若两个报文段 `src_xx` 不同，`dst_xx` 相同，会被定位到不同的套接字。
		* 两个 B 主机上的进程（源端口不同）向 A 发送 **TCP** 报文，会被 A 定位到不同的套接字。
		* 感觉 **欢迎套接字** 是使用 `(dst_IP、dst_port)` 来标识的，因为 `src_port` 和 `srt_IP` 不同的报文段都会被定位到该套接字上。

* 3.3 无连接运输：UDP
	* **UDP** 在发送报文段前，发送方和接收方没有握手，因此 **UDP** 被称为是 **无连接** 的。
	* **选择 UDP 的理由**
		* 能容忍部分丢失，要求最小发送速率的应用：不受拥塞控制机制扼制发送速率，不受可靠交付长时间的延时制约
		* 无需连接建立：不会引入建立连接时延
		* 无连接状态：包括接收发送缓存，拥塞控制参数以及序列号确认号参数
		* 分组首部开销小
	* 3.3.1 **UDP** 报文段结构
	* 3.3.2 **UDP** 校验和 [checksum.c](https://github.com/YangXiaoHei/Networking/blob/master/03%20运输层/progs/checksum.c)
	
* 3.4 可靠数据传输原理：
	* **基于假设：分组将以发送的次序进行交付，某些分组可能会丢失，但底层信道不会对分组重排序**

	* 3.4.1 构造可靠数据传输协议

		* 1. 经完全可靠信道的可靠数据传输: rdt 1.0
	![rdt_1_0](https://github.com/YangXiaoHei/Networking/blob/master/03%20运输层/images/rdt_1_0.png)
		
		* 2. 经具有比特差错信道的可靠数据传输：
			* rdt 2.0 未考虑 **ACK** 或 **NAK** 包也会损坏
			![rdt_2_0](https://github.com/YangXiaoHei/Networking/blob/master/03%20运输层/images/rdt_2_0.png)
			* rdt 2.1 考虑了 **ACK** 和 **NAK** 会损坏的情况
			![rdt_2_1](https://github.com/YangXiaoHei/Networking/blob/master/03%20运输层/images/rdt_2_1.png)
			* rdt 2.2 考虑了 **ACK** 和 **NAK** 会损坏的情况，不使用 **NAK** 从而减少接收端一个状态
			![rdt_2_2](https://github.com/YangXiaoHei/Networking/blob/master/03%20运输层/images/rdt_2_2.png)
		* 3. 经具有比特差错的丢包信道的可靠数据传输：rdt 3.0
		![rdt_3_0](https://github.com/YangXiaoHei/Networking/blob/master/03%20运输层/images/rdt_3_0.png)
	* 3.4.2 流水线可靠数据传输协议
		* 定义发送方的信道利用率为：发送方实际忙于将比特发送进信道的那部分时间与发送时间之比

		
		* 采用流水线技术对可靠数据传输协议带来如下影响：
			1. 必须增加序号范围，每个传输中的分组必须有一个唯一的序号，而且也许有许多个在输送中未确认的报文。

			
			2. 协议的发送方和接受两端也许必须缓存多个分组。发送方最低限度应当能缓存那些已发送但没有确认的分组。接收方或许也需要缓存那些已正确接受的分组。

			
			3. 所需序号范围和对缓存的要求取决于如何处理丢失、损坏及延时过大的分组。流水线差错恢复有两种基本方法：**回退 N 步 (Go-Back-N, GBN)** 和 **选择重传 (Selective Repeat, SR)**
	
	* 3.4.3 回退 N 步
	
	* 3.4.4 选择重传


	
	
		
